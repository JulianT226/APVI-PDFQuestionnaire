{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <form method="POST" id="pdfForm">
            {{ form.csrf_token }}

            <!-- State Selection Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">1</div>
                    <h3>Visa Selection</h3>
                </div>
                <div class="section-content">
                    <div class="mb-4">
                        <label class="form-label">
                            Which consulate office are you applying through?<span style="color: red">*</span>
                            <span 
                                class="text-primary ms-1" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="right" 
                                title="Ensure this matches the consulate listed on your Letter of Invitation and/or your Support Letter. If you do not yet have these documents, we recommend choosing 'Washington, D.C.' and ensuring your documents are made accordingly.">
                                <i class="bi bi-info-circle"></i>
                            </span>
                        </label>
                        {{ form.state(class="form-select") }}
                        {% if form.state.errors %}
                            {% for error in form.state.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.visa_type.label(class="form-label") }}
                        {{ form.visa_type(class="form-select") }}
                        {% if form.visa_type.errors %}
                            {% for error in form.visa_type.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- "What visa should I pick?" link -->
                    <p>
                      <a class="text-primary" data-bs-toggle="collapse" href="#visaHelp" role="button" aria-expanded="false" aria-controls="visaHelp">
                        What visa is right for me?
                      </a>
                    </p>
                    <!-- Collapsible container with a brief explanation of each visa type -->
                    <div class="collapse" id="visaHelp">
                      <div class="card card-body">
                        <p>
                            <strong>Work</strong>: For individuals planning to work in Saudi Arabia under a sponsorship agreement. This visa is typically arranged by the employer.<br>
                        </p>
                        <p>
                            <strong>Residential</strong>: For individuals relocating to Saudi Arabia for long-term residency, such as dependents of expatriates or those holding iqama (residence permit) status.<br>
                        </p>
                        <p>
                            <strong>Student</strong>: For individuals traveling to Saudi Arabia to pursue education at a university or other educational institutions.<br>
                        </p>
                        <p>
                            <strong>Diplomat</strong>: For diplomats and consular staff visiting or assigned to Saudi Arabia on official diplomatic missions.<br>
                        </p>
                        <p>
                            <strong>Personal Visit</strong>: For private, individual visits that are not family-related or work-related.<br>
                        </p>
                        <p>
                            <strong>Tourist</strong>: For those traveling strictly for tourism/leisure.<br>
                        </p>
                        <p>
                            <strong>Commerce</strong>: For individuals traveling for trade purposes, including meetings with Saudi companies or signing business deals.<br>
                        </p>
                        <p>
                            <strong>Business</strong>: Similar to the commerce visa but specifically targeted at high-level business executives and investors.<br>
                        </p>
                        <p>
                            <strong>Government</strong>: For those traveling on official government assignments.<br>
                        </p>
                        <p>
                            <strong>Work Visit</strong>: For short-term work assignments or contracts in Saudi Arabia without seeking long-term employment.<br>
                        </p>
                        <p>
                            <strong>Family Visit</strong>: For individuals visiting family members who live in Saudi Arabia.<br>
                        </p>
                        <p>
                            <strong>Other</strong>: For travel purposes that do not fall under any of the above categories.<br>
                        </p>
                      </div>
                    </div>
                </div>
            </div>
            
            <!-- Personal Information Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">2</div>
                    <h3>Personal Information</h3>
                </div>
                <div class="section-content">
                    <div class="mb-3">
                        <label class="form-label">Full Name<span style="color: red">*</span></label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.first_name(class="form-control", placeholder="First name") }}
                                {% if form.first_name.errors %}
                                    {% for error in form.first_name.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.middle_name(class="form-control", placeholder="Middle name") }}
                                {% if form.middle_name.errors %}
                                    {% for error in form.middle_name.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.last_name(class="form-control", placeholder="Last name") }}
                                {% if form.last_name.errors %}
                                    {% for error in form.last_name.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.dob.id }}">{{ form.dob.label.text }}<span style="color: red">*</span></label>
                            {{ form.dob(class="form-control", type="date") }}
                            {% if form.dob.errors %}
                                {% for error in form.dob.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.birth_place.id }}">{{ form.birth_place.label.text }}<span style="color: red">*</span></label>
                            {{ form.birth_place(class="form-control", placeholder="Enter country of birth, e.g. 'United States'") }}
                            {% if form.birth_place.errors %}
                                {% for error in form.birth_place.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="{{ form.present_nationality.id }}">{{ form.present_nationality.label.text }}<span style="color: red">*</span></label>
                        {{ form.present_nationality(class="form-control", placeholder="Enter current nationality, e.g. 'American'") }}
                        {% if form.present_nationality.errors %}
                            {% for error in form.present_nationality.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">
                                Do you have a previous nationality?<span style="color: red">*</span>
                                <span 
                                    class="text-primary ms-1" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="right" 
                                    title="If you were born/raised in a country different from your present nationality, select 'Yes'">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </label>
                            <div class="radio-card-group">
                                {% for subfield in form.has_prev_nationality %}
                                <div class="radio-card">
                                    <input type="radio" id="{{ subfield.id }}" name="{{ subfield.name }}" value="{{ subfield.data }}" {% if subfield.checked %}checked{% endif %} required onclick="togglePrevNationality({{ 'true' if subfield.data == 'Yes' else 'false' }})">
                                    <label for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                </div>
                                {% endfor %}

                            </div>
                        </div>
                    </div>

                    <!-- Previous Nationality Field (hidden by default) -->
                    <div class="mb-3" id="prevNationalityField" style="display: none;">
                            <label class="form-label" for="{{ form.prev_nationality.id }}">{{ form.prev_nationality.label.text }}<span style="color: red">*</span></label>
                            {{ form.prev_nationality(class="form-control", placeholder="Enter previous nationality") }}
                            {% if form.prev_nationality.errors %}
                                {% for error in form.prev_nationality.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                    </div>
                </div>
            </div>

            <!-- Personal Details Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">3</div>
                    <h3>Personal Details</h3>
                </div>
                <div class="section-content">
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">{{ form.sex.label.text }}<span style="color: red">*</span></label>
                            <div class="radio-card-group">
                                {% for subfield in form.sex %}
                                <div class="radio-card">
                                    <input type="radio" id="{{ subfield.id }}" name="{{ subfield.name }}" value="{{ subfield.data }}" {% if subfield.checked %}checked{% endif %} required>
                                    <label for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback d-block" style="display: none;"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">{{ form.marital_status.label.text }}<span style="color: red">*</span></label>
                            <div class="radio-card-group">
                                {% for subfield in form.marital_status %}
                                <div class="radio-card">
                                    <input type="radio" id="{{ subfield.id }}" name="{{ subfield.name }}" value="{{ subfield.data }}" {% if subfield.checked %}checked{% endif %} required>
                                    <label for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback d-block" style="display: none;"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">{{ form.religion.label.text }}<span style="color: red">*</span></label>
                            <div class="radio-card-group">
                                {% for subfield in form.religion %}
                                <div class="radio-card">
                                    <input type="radio" id="{{ subfield.id }}" name="{{ subfield.name }}" value="{{ subfield.data }}" {% if subfield.checked %}checked{% endif %} required>
                                    <label for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback d-block" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                Job Title<span style="color: red">*</span>
                                <span 
                                    class="text-primary ms-1" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="right" 
                                    title='Ensure this matches the job title on your letter of invitation. If the applicant is a child, enter "Student"'>
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </label>
                            {{ form.profession(class="form-control", placeholder="Enter profession") }}
                            {% if form.profession.errors %}
                                {% for error in form.profession.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                Highest Degree Earned<span style="color: red">*</span>
                                <span 
                                    class="text-primary ms-1" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="right" 
                                    title='If you do not have a degree, enter the number of years you have been working, e.g. "20 years"'>
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </label>
                            {{ form.qualification(class="form-control", placeholder="E.g. 'Bachelor of Science'") }}
                            {% if form.qualification.errors %}
                                {% for error in form.qualification.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <div id="motherNYSection" style="display: none;">
                        <hr>
                        <label class="form-label">Mother's Name<span style="color: red">*</span></label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.mother_name_first(class="form-control", placeholder="First Name") }}
                                {% if form.mother_name_first.errors %}
                                    {% for error in form.mother_name_first.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.mother_name_middle(class="form-control", placeholder="Middle Name") }}
                                {% if form.mother_name_middle.errors %}
                                    {% for error in form.mother_name_middle.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.mother_name_last(class="form-control", placeholder="Last Name") }}
                                {% if form.mother_name_last.errors %}
                                    {% for error in form.mother_name_last.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Contact Information Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">4</div>
                    <h3>Contact Information</h3>
                </div>
                <div class="section-content">
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.email.id }}">{{ form.email.label.text }}<span style="color: red">*</span></label>
                        {{ form.email(class="form-control", placeholder="Enter email address") }}
                        {% if form.email.errors %}
                            {% for error in form.email.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.phone_num.id }}">{{ form.phone_num.label.text }}<span style="color: red">*</span></label>
                        {{ form.phone_num(class="form-control", placeholder="Enter phone number") }}
                        {% if form.phone_num.errors %}
                            {% for error in form.phone_num.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <hr class="my-4">
                    
                    <div class="row g-3">
                        <label class="form-label"><strong>Home Address</strong></label>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.address_street.id }}">{{ form.address_street.label.text }}<span style="color: red">*</span></label>
                            {{ form.address_street(class="form-control", placeholder="Enter street address") }}
                            {% if form.address_street.errors %}
                                {% for error in form.address_street.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.address_city.id }}">{{ form.address_city.label.text }}<span style="color: red">*</span></label>
                            {{ form.address_city(class="form-control", placeholder="Enter city") }}
                            {% if form.address_city.errors %}
                                {% for error in form.address_city.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <br>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.address_state.id }}">{{ form.address_state.label.text }}<span style="color: red">*</span></label>
                            {{ form.address_state(class="form-control", placeholder="Enter state") }}
                            {% if form.address_state.errors %}
                                {% for error in form.address_state.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.address_zip.id }}">{{ form.address_zip.label.text }}</label>
                            {{ form.address_zip(class="form-control", placeholder="Enter zip code") }}
                            {% if form.address_zip.errors %}
                                {% for error in form.address_zip.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.address_country.id }}">{{ form.address_country.label.text }}<span style="color: red">*</span></label>
                            {{ form.address_country(class="form-control", placeholder="Enter country") }}
                            {% if form.address_country.errors %}
                                {% for error in form.address_country.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passport Information Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">5</div>
                    <h3>Passport Information</h3>
                </div>
                <div class="section-content">
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.pass_num.id }}">{{ form.pass_num.label.text }}<span style="color: red">*</span></label>
                        {{ form.pass_num(class="form-control", placeholder="Enter passport number") }}
                        {% if form.pass_num.errors %}
                            {% for error in form.pass_num.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            Country of Issue<span style="color: red"">*</span>
                            <span 
                                class="text-primary ms-1" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="right" 
                                title="Only enter the country of issue, do NOT enter a state/province.">
                                <i class="bi bi-info-circle"></i>
                            </span>
                        </label>
                        {{ form.pass_issue_place(class="form-control", placeholder="Enter country") }}
                        {% if form.pass_issue_place.errors %}
                            {% for error in form.pass_issue_place.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.pass_iss.id }}">{{ form.pass_iss.label.text }}<span style="color: red">*</span></label>
                            {{ form.pass_iss(class="form-control", type="date") }}
                            {% if form.pass_iss.errors %}
                                {% for error in form.pass_iss.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.pass_exp.id }}">{{ form.pass_exp.label.text }}<span style="color: red">*</span></label>
                            {{ form.pass_exp(class="form-control", type="date") }}
                            {% if form.pass_exp.errors %}
                                {% for error in form.pass_exp.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Employment Information Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">6</div>
                    <h3>Employment Information</h3>
                </div>
                <div class="section-content">
                    <div class="row g-3">
                        <label class="form-label">
                            <strong>Employer Address</strong>
                            <span 
                                class="text-primary ms-1" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="right" 
                                title="If the applicant is a child, leave this blank and move to the next step.">
                                <i class="bi bi-info-circle"></i>
                            </span>
                        </label>
                        <div class="col-md-6">
                            {{ form.bus_address_street.label(class="form-label") }}
                            {{ form.bus_address_street(class="form-control", placeholder="Enter your employer\'s street address") }}
                            {% if form.bus_address_street.errors %}
                                {% for error in form.bus_address_street.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.bus_address_city.label(class="form-label") }}
                            {{ form.bus_address_city(class="form-control", placeholder="Enter city") }}
                            {% if form.bus_address_city.errors %}
                                {% for error in form.bus_address_city.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <br>
                    <div class="row g-3">
                        <div class="col-md-4">
                            {{ form.bus_address_state.label(class="form-label") }}
                            {{ form.bus_address_state(class="form-control", placeholder="Enter state/province") }}
                            {% if form.bus_address_state.errors %}
                                {% for error in form.bus_address_state.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.bus_address_zip.label(class="form-label") }}
                            {{ form.bus_address_zip(class="form-control", placeholder="Enter zip code") }}
                            {% if form.bus_address_zip.errors %}
                                {% for error in form.bus_address_zip.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.bus_address_country.label(class="form-label") }}
                            {{ form.bus_address_country(class="form-control", placeholder="Enter country") }}
                            {% if form.bus_address_country.errors %}
                                {% for error in form.bus_address_country.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <br>
                    <div class="mb-3">
                        {{ form.bus_phone_num.label(class="form-label") }}
                        {{ form.bus_phone_num(class="form-control", placeholder="Enter your employer\'s phone number") }}
                        {% if form.bus_phone_num.errors %}
                            {% for error in form.bus_phone_num.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Inviting Person/Org Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">7</div>
                    <h3>Inviting Person/Organization Information</h3>
                </div>
                <div class="section-content">
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.inviting_name.id }}">{{ form.inviting_name.label.text }}</label>
                        {{ form.inviting_name(class="form-control", placeholder="Enter name of inviting person/organization") }}
                        {% if form.inviting_name.errors %}
                            {% for error in form.inviting_name.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <hr class="my-4">
                    <div class="row g-3">
                        <label class="form-label"><strong>Address</strong></label>
                        <div class="col-md-6">
                            {{ form.inviting_address_street.label(class="form-label") }}
                            {{ form.inviting_address_street(class="form-control", placeholder="Enter street address of inviting person/organization") }}
                            {% if form.inviting_address_street.errors %}
                                {% for error in form.inviting_address_street.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.inviting_address_city.label(class="form-label") }}
                            {{ form.inviting_address_city(class="form-control", placeholder="Enter city") }}
                            {% if form.inviting_address_city.errors %}
                                {% for error in form.inviting_address_city.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <br>
                    <div class="row g-3">
                        <div class="col-md-4">
                            {{ form.inviting_address_province.label(class="form-label") }}
                            {{ form.inviting_address_province(class="form-control", placeholder="Enter state") }}
                            {% if form.inviting_address_province.errors %}
                                {% for error in form.inviting_address_province.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.inviting_address_postal_code.label(class="form-label") }}
                            {{ form.inviting_address_postal_code(class="form-control", placeholder="Enter postal code") }}
                            {% if form.inviting_address_postal_code.errors %}
                                {% for error in form.inviting_address_postal_code.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.inviting_address_country.label(class="form-label") }}
                            {{ form.inviting_address_country(class="form-control", placeholder="Enter country") }}
                            {% if form.inviting_address_country.errors %}
                                {% for error in form.inviting_address_country.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Travel Information Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">8</div>
                    <h3>Travel Information</h3>
                </div>
                <div class="section-content">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                Arrival Date<span id="arrivingAsterisk" style="display: none; color: red">*</span>
                                <span
                                    class="text-primary ms-1" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="right" 
                                    title="If you do not have a specific date yet, you can enter your best estimation of your arrival date.">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </label>
                            {{ form.arrival_date(class="form-control", type="date") }}
                            {% if form.arrival_date.errors %}
                                {% for error in form.arrival_date.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <div id="departureDateNYSection">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Departure Date<span id="departingAsterisk" style="display: none; color: red">*</span>
                                        <span
                                            class="text-primary ms-1" 
                                            data-bs-toggle="tooltip" 
                                            data-bs-placement="right" 
                                            title="If you do not have a specific date yet, you can enter your best estimation of your departure date.">
                                            <i class="bi bi-info-circle"></i>
                                        </span>
                                    </label>
                                    {{ form.departure_date(class="form-control", type="date") }}
                                    {% if form.departure_date.errors %}
                                        {% for error in form.departure_date.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6" id="departingCityField">
                            <label class="form-label">
                                {{ form.departing_city.label.text }}<span id="departingCityAsterisk" style="display: none; color: red">*</span>
                                <span 
                                    class="text-primary ms-1" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="right" 
                                    title="Enter the last city you will depart from before arriving in Saudi Arabia.">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </label>
                            {{ form.departing_city(class="form-control", placeholder="Enter departing city") }}
                            {% if form.departing_city.errors %}
                                {% for error in form.departing_city.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6" id="arrivingCityField">
                            <label class="form-label">
                                {{ form.arriving_city.label.text }}<span id="arrivingCityAsterisk" style="display: none; color: red"">*</span>
                                <span 
                                    class="text-primary ms-1" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="right" 
                                    title="Enter your city of arrival in Saudi Arabia.">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </label>
                            {{ form.arriving_city(class="form-control", placeholder="Enter arriving city") }}
                            {% if form.arriving_city.errors %}
                                {% for error in form.arriving_city.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6" id="airlineField">
                            <div id="airlineNYSection">
                                <label class="form-label" for="{{ form.airline.id }}">
                                    {{ form.airline.label.text }}<span id="airlineAsterisk" style="display: none; color: red">*</span>
                                </label>
                                {{ form.airline(class="form-control", placeholder="Enter airline name") }}
                                {% if form.airline.errors %}
                                    {% for error in form.airline.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="flightNumNYSection">
                                <label class="form-label" for="{{ form.flight_num.id }}"> 
                                    {{ form.flight_num.label.text }}<span id="flightAsterisk" style="display: none; color: red">*</span>
                                </label>
                                {{ form.flight_num(class="form-control", placeholder="Enter flight number") }}
                                {% if form.flight_num.errors %}
                                    {% for error in form.flight_num.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="{{ form.stay_duration.id }}">
                            {{ form.stay_duration.label.text }}<span id="stayDurationAsterisk" style="display: none; color: red">*</span>
                            <span
                                class="text-primary ms-1" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="right" 
                                title="If you do not have a specific stay duration yet, you can enter your best estimate.">
                                <i class="bi bi-info-circle"></i>
                            </span>
                        </label>
                        {{ form.stay_duration(class="form-control", placeholder="Enter duration of stay, e.g. '5 days'") }}
                        {% if form.stay_duration.errors %}
                            {% for error in form.stay_duration.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Child Applicant Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="step-number">9</div>
                    <h3>Child Applicant Information</h3>
                </div>
                <div class="section-content">
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            {{ form.is_child.label(class="form-label") }}<span style="color: red">*</span>
                            <div class="radio-card-group">
                                {% for subfield in form.is_child %}
                                <div class="radio-card">
                                    <input type="radio" id="{{ subfield.id }}" name="{{ subfield.name }}" value="{{ subfield.data }}" {% if subfield.checked %}checked{% endif %} required onclick="toggleTravelingCompanion({{ 'true' if subfield.data == 'Yes' else 'false' }})">
                                    <label for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <!-- Traveling Companion Field (hidden by default) -->
                    <div class="row g-3 mb-3" id="travelingCompanionField" style="display: none;">
                        <br>
                        <div class="mb-3">
                            <label class="form-label">Name of Adult Traveling with the Applicant<span style="color: red">*</span></label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    {{ form.traveling_companion_first_name(class="form-control", placeholder="First Name") }}
                                    {% if form.traveling_companion_first_name.errors %}
                                        {% for error in form.traveling_companion_first_name.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    {{ form.traveling_companion_middle_name(class="form-control", placeholder="Middle Name") }}
                                    {% if form.traveling_companion_middle_name.errors %}
                                        {% for error in form.traveling_companion_middle_name.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    {{ form.traveling_companion_last_name(class="form-control", placeholder="Last Name") }}
                                    {% if form.traveling_companion_last_name.errors %}
                                        {% for error in form.traveling_companion_last_name.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div id="travelCompanionNYSection" style="display: none;">
                            <hr>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Date of Birth<span style="color: red">*</span></label>
                                    {{ form.traveling_companion_dob(class="form-control", type="date") }}
                                    {% if form.traveling_companion_dob.errors %}
                                        {% for error in form.traveling_companion_dob.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Sex<span style="color: red">*</span></label>
                                    <div class="radio-card-group">
                                        {% for subfield in form.traveling_companion_sex %}
                                        <div class="radio-card">
                                            <input type="radio" id="{{ subfield.id }}" name="{{ subfield.name }}" value="{{ subfield.data }}" {% if subfield.checked %}checked{% endif %}>
                                            <label for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="invalid-feedback d-block" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Relationship with the Applicant<span style="color: red">*</span></label>
                            {{ form.traveling_companion_relationship(class="form-control", placeholder="e.g. Mother, Father, etc.") }}
                            {% if form.traveling_companion_relationship.errors %}
                                {% for error in form.traveling_companion_relationship.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                <script>
                    function toggleTravelingCompanion(show) {
                        const travelingCompanionField = document.getElementById('travelingCompanionField');
                        travelingCompanionField.style.display = show ? 'block' : 'none';
                    }
                </script>
            </div>
        </form>
    </div>
</div>

<!-- Modal Definitions -->

<!-- Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header"> 
            <h5 class="modal-title" id="validationModalLabel">Input Error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        <!-- The custom message will be inserted here -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
        </div>
    </div>
</div>

<!-- NY Eligibility Modal -->
<div class="modal fade" id="nyEligibilityModal" tabindex="-1" aria-labelledby="nyEligibilityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"> 
                <h5 class="modal-title" id="nyEligibilityModalLabel">New York Eligibility</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                In order to apply through the New York Consulate office, you must reside in one of the following states:
                <ul>
                    <li>Connecticut</li>
                    <li>Indiana</li>
                    <li>Maine</li>
                    <li>Massachusetts</li>
                    <li>Michigan</li>
                    <li>New Hampshire</li>
                    <li>New Jersey</li>
                    <li>New York</li>
                    <li>Pennsylvania</li>
                    <li>Rhode Island</li>
                    <li>Vermont</li>
                </ul>
                If you do not reside in one of these states, we recommend you apply through the Washington, D.C. Consulate instead.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="nyEligibilityModalConfirm">Continue</button>
            </div>
        </div>
    </div>
</div>

<!-- Job Title Check Modal -->
<div class="modal fade" id="jobTitleModal" tabindex="-1" aria-labelledby="jobTitleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"> 
                <h5 class="modal-title" id="jobTitleModalLabel">Confirm Job Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Please confirm that the job title you entered matches the one on your letter of invitation. A discrepancy can result in a rejected application.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="jobTitleModalConfirm">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Consolidated JavaScript -->
<script>
    /* ===================== HELPER FUNCTIONS ===================== */
    function togglePrevNationality(show) {
        const prevNationalityField = document.getElementById('prevNationalityField');
        prevNationalityField.style.display = show ? 'block' : 'none';
    }    

    function toggleTravelingCompanion(show) {
        const travelingCompanionField = document.getElementById('travelingCompanionField');
        travelingCompanionField.style.display = show ? 'block' : 'none';
    }

    function toggleNYFields() {
        const motherNYSection = document.getElementById('motherNYSection');
        const travelCompanionNYSection = document.getElementById('travelCompanionNYSection');
        const departureDateNYSection = document.getElementById('departureDateNYSection');
        const flightNumNYSection = document.getElementById('flightNumNYSection');
        const stateSelect = document.getElementById('{{ form.state.id }}');
        const selectedState = stateSelect.value;

        if (selectedState === "New York, NY") {
            departureDateNYSection.style.display = 'block';
            travelCompanionNYSection.style.display = 'block';
            flightNumNYSection.style.display = 'none';
        } else {
            departureDateNYSection.style.display = 'none';
            travelCompanionNYSection.style.display = 'none';
            flightNumNYSection.style.display = 'block';
        }
        if (selectedState === "New York, NY" || selectedState === "Los Angeles, CA") {
            motherNYSection.style.display = 'block';
        } else {
            motherNYSection.style.display = 'none';
        }
    }

    const nyVisaOptions = [
        {value: 'WORK', text: 'Work'},
        {value: 'TRANSIT', text: 'Transit'},
        {value: 'VISIT', text: 'Visit'},
        {value: 'RESIDENCE', text: 'Residential'},
        {value: 'DIPLOMACY', text: 'Diplomacy'}
    ];

    const allVisaOptions = [
        {value: 'EMPLOYMENT', text: 'Work'},
        {value: 'RESIDENCE', text: 'Residential'},
        {value: 'STUDENT', text: 'Student'},
        {value: 'DIPLOMAT', text: 'Diplomat'},
        {value: 'PERSONNEL', text: 'Personal Visit'},
        {value: 'COMMERCE', text: 'Commerce'},
        {value: 'BUSINESS', text: 'Business'},
        {value: 'GOVERNMENT', text: 'Government'},
        {value: 'WORK VISIT', text: 'Temporary Work'},
        {value: 'FAMILY VISIT', text: 'Family Visit'},
        {value: 'OTHER', text: 'Other'}
    ];

    function toggleNYVisaDropdown() {
        const stateSelect = document.getElementById('{{ form.state.id }}');
        const visaSelect = document.getElementById('{{ form.visa_type.id }}');
        const selectedState = stateSelect.value;
        visaSelect.options.length = 0;
        if (selectedState === "New York, NY") {
            nyVisaOptions.forEach(opt => {
                let newOption = new Option(opt.text, opt.value);
                visaSelect.add(newOption);
            });
        } else {
            allVisaOptions.forEach(opt => {
                let newOption = new Option(opt.text, opt.value);
                visaSelect.add(newOption);
            });
        }
    }

    function toggleTravelRequirements() {
        const stateSelect = document.getElementById('{{ form.state.id }}');
        const selectedState = stateSelect.value;
        const isRequired = (selectedState === "New York, NY" || selectedState === "Los Angeles, CA");
        const travelFields = [
            document.getElementById('{{ form.arrival_date.id }}'),
            document.getElementById('{{ form.departing_city.id }}'),
            document.getElementById('{{ form.arriving_city.id }}'),
            document.getElementById('{{ form.stay_duration.id }}')
        ];
        travelFields.forEach(field => {
            if (field) {
                if (isRequired) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
            }
        }
    });
    function setAsteriskDisplay(idStr) {
        const el = document.getElementById(idStr);
            if (el) {
                el.style.display = isRequired ? 'inline' : 'none';
            }
        }
    setAsteriskDisplay('arrivingAsterisk');
    setAsteriskDisplay('departingCityAsterisk');
    setAsteriskDisplay('arrivingCityAsterisk');
    setAsteriskDisplay('stayDurationAsterisk');
    }

    function toggleTravelRequirementsNY() {
        const stateSelect = document.getElementById('{{ form.state.id }}');
        const selectedState = stateSelect.value;
        const isRequired = (selectedState === "New York, NY");
        const travelFields = [
            document.getElementById('{{ form.departure_date.id }}'),
        ];
        travelFields.forEach(field => {
            if (field) {
                if (isRequired) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
            }
        }
    });
    function setAsteriskDisplay(idStr) {
        const el = document.getElementById(idStr);
            if (el) {
                el.style.display = isRequired ? 'inline' : 'none';
            }
        }
    setAsteriskDisplay('departureAsterisk');
    }


    function toggleDepartingCityField() {
        const stateSelect = document.getElementById('{{ form.state.id }}');
        const selectedState = stateSelect.value;
        const departingCityField = document.getElementById('departingCityField');
        const departingCityInput = document.getElementById('{{ form.departing_city.id }}');
        const departingCityAsterisk = document.getElementById('departingCityAsterisk');
        if (selectedState === "New York, NY") {
            departingCityField.style.display = 'none';
            if (departingCityInput) {
                departingCityInput.removeAttribute('required');
            }
            if (departingCityAsterisk) {
                departingCityAsterisk.style.display = 'none';
            }
        } else {
            departingCityField.style.display = 'block';
            if (departingCityInput) {
                departingCityInput.setAttribute('required', 'required');
            }
            if (departingCityAsterisk) {
                departingCityAsterisk.style.display = (selectedState === "Los Angeles, CA") ? 'inline' : 'none';
            }
        }
    }

    function toggleFullWidthFieldsForNY() {
        const stateSelect = document.getElementById('{{ form.state.id }}');
        const selectedState = stateSelect.value;
        const arrivingCityField = document.getElementById('arrivingCityField');
        const airlineField = document.getElementById('airlineField');
        if (selectedState === "New York, NY") {
            if (arrivingCityField) {
                arrivingCityField.classList.remove('col-md-6');
                arrivingCityField.classList.add('col-md-12');
            }
            if (airlineField) {
                airlineField.classList.remove('col-md-6');
                airlineField.classList.add('col-md-12');
            }
        } else {
            if (arrivingCityField) {
                arrivingCityField.classList.remove('col-md-12');
                arrivingCityField.classList.add('col-md-6');
            }
            if (airlineField) {
                airlineField.classList.remove('col-md-12');
                airlineField.classList.add('col-md-6');
            }
        }
    }
    
    

  /* =========== DOMContentLoaded HANDLER =========== */
  document.addEventListener('DOMContentLoaded', function() {
    // --- Initial Setup ---
    toggleNYVisaDropdown();
    toggleNYFields();
    toggleTravelRequirements();
    toggleTravelRequirementsNY();
    toggleDepartingCityField();
    toggleFullWidthFieldsForNY();

    const stateSelect = document.getElementById('{{ form.state.id }}');
    stateSelect.addEventListener('change', function() {
        toggleNYVisaDropdown();
        toggleNYFields();
        toggleTravelRequirements();
        toggleTravelRequirementsNY();
        toggleDepartingCityField();
        toggleFullWidthFieldsForNY();
        
        if (this.value === "New York, NY") {
            const nyModal = new bootstrap.Modal(document.getElementById('nyEligibilityModal'));
            nyModal.show();
        }
    });

    // --- Multi-Section Navigation Setup ---
    const form = document.getElementById('pdfForm');
    if (!form) return;
    const formSections = form.querySelectorAll('.form-section');
    let currentSection = 0;
    let pendingNavigationIndex = null;

    // Hide all sections except the first:
    formSections.forEach((section, index) => {
        section.style.display = index === 0 ? 'block' : 'none';
    });


    // *** Create Progress Indicator Here ***
    const progressContainer = document.createElement('div');
    progressContainer.className = 'progress-container mb-4';
    progressContainer.innerHTML = `
        <div class="progress-steps d-flex justify-content-between">
            ${Array.from(formSections).map((section, index) => `
                <div class="progress-step ${index === 0 ? 'active' : ''}">
                    <div class="step-number">${index + 1}</div>
                    <div class="step-label">${section.querySelector('h3').textContent}</div>
                </div>
            `).join('')}
        </div>
    `;
    // Insert the progress indicator at the top of the form:
    form.insertBefore(progressContainer, form.firstChild);

    // Save references to the progress step elements for later updates:
    const progressSteps = document.querySelectorAll('.progress-step');
      
    // Navigation function:
    function navigateSection(index) {
        formSections[currentSection].style.display = 'none';
        formSections[index].style.display = 'block';
        currentSection = index;
        progressSteps.forEach((step, i) => {
            if (i === currentSection) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        formSections[index].scrollIntoView({ behavior: 'smooth' });
    }

    // --- Create Navigation Buttons ---
    formSections.forEach((section, index) => {
      const navButtons = document.createElement('div');
      navButtons.className = 'form-navigation d-flex justify-content-between mt-4';
      const leftContainer = document.createElement('div');
      const rightContainer = document.createElement('div');

      if (index > 0) {
        const prevButton = document.createElement('button');
        prevButton.type = 'button';
        prevButton.className = 'btn btn-outline-primary ms-3';
        prevButton.innerHTML = '<i class="fas fa-arrow-left me-2"></i>Previous';
        prevButton.onclick = () => navigateSection(index - 1);
        leftContainer.appendChild(prevButton);
      }

      if (index === formSections.length - 1) {
        const submitButton = document.createElement('button');
        submitButton.type = 'submit';
        submitButton.className = 'btn btn-primary ms-auto';
        submitButton.innerHTML = 'Submit';
        rightContainer.appendChild(submitButton);
      } else {
        const navigationButton = document.createElement('button');
        navigationButton.type = 'button';
        navigationButton.className = 'btn btn-primary';
        navigationButton.innerHTML = 'Next<i class="fas fa-arrow-right ms-2"></i>';
        if (index === 2) {
          // Special handling for step 3 (job title check)
          navigationButton.onclick = () => {
            if (validateSection(index)) {
              const selectedVisa = document.getElementById('visa_type').value;
              if (selectedVisa === 'BUSINESSMEN' || selectedVisa === 'GOVERNMENT') {
                const jobTitleModal = new bootstrap.Modal(document.getElementById('jobTitleModal'));
                jobTitleModal.show();
                pendingNavigationIndex = index + 1;
              } else {
                navigateSection(index + 1);
              }
            }
          };
        } else {
          navigationButton.onclick = () => {
            if (validateSection(index)) {
              navigateSection(index + 1);
            }
          };
        }
        rightContainer.appendChild(navigationButton);
      }
      navButtons.appendChild(leftContainer);
      navButtons.appendChild(rightContainer);
      section.querySelector('.section-content').appendChild(navButtons);
    });

    // --- Validation Function ---
    function validateSection(index) {
      const section = formSections[index];
      let isValid = true;
      const requiredFields = section.querySelectorAll('[required]:not([style*="display: none"])');
      const checkedRadioGroups = {};
      requiredFields.forEach(field => {
        if (field.type === 'radio') {
          const parent = field.closest('.radio-card-group') || field.parentNode;
          const name = field.name;
          if (!checkedRadioGroups[name]) {
            const checkedRadio = section.querySelector(`input[name="${name}"]:checked`);
            if (!checkedRadio) {
              isValid = false;
              const radios = section.querySelectorAll(`input[name="${name}"]`);
              radios.forEach(radio => radio.classList.add('is-invalid'));
              let feedback = parent.querySelector('.invalid-feedback');
              if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback d-block';
                feedback.textContent = 'Please select an option.';
                parent.appendChild(feedback);
              }
            } else {
              const radios = section.querySelectorAll(`input[name="${name}"]`);
              radios.forEach(radio => radio.classList.remove('is-invalid'));
              const feedback = parent.querySelector('.invalid-feedback');
              if (feedback) feedback.remove();
            }
            checkedRadioGroups[name] = true;
          }
        } else {
          if (!field.value.trim()) {
            isValid = false;
            field.classList.add('is-invalid');
            let feedback = field.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
              feedback = document.createElement('div');
              field.parentNode.appendChild(feedback);
            }
            feedback.className = 'invalid-feedback d-block';
            feedback.textContent = 'This field is required';
          } else {
            field.classList.remove('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
              feedback.remove();
            }
          }
        }
      });
      return isValid;
    }

    // --- Modal Confirm Buttons ---
    const nyEligibilityConfirmButton = document.getElementById('nyEligibilityModalConfirm');
    if (nyEligibilityConfirmButton) {
      nyEligibilityConfirmButton.onclick = () => {
        if (pendingNavigationIndex !== null) {
          navigateSection(pendingNavigationIndex);
          pendingNavigationIndex = null;
        }
        const nyModalInstance = bootstrap.Modal.getInstance(document.getElementById('nyEligibilityModal'));
        if (nyModalInstance) {
          nyModalInstance.hide();
        }
      };
    }

    const jobTitleConfirmButton = document.getElementById('jobTitleModalConfirm');
    if (jobTitleConfirmButton) {
      jobTitleConfirmButton.onclick = () => {
        if (pendingNavigationIndex !== null) {
          navigateSection(pendingNavigationIndex);
          pendingNavigationIndex = null;
        }
        const jobTitleModal = bootstrap.Modal.getInstance(document.getElementById('jobTitleModal'));
        if (jobTitleModal) {
          jobTitleModal.hide();
        }
      };
    }

    // --- URL Parameter Handling ---
    const urlParams = new URLSearchParams(window.location.search);
    const sectionParam = urlParams.get('section');
    const sectionMap = {
      'visa': 0,
      'personal': 1,
      'details': 2,
      'contact': 3,
      'passport': 4,
      'employment': 5,
      'inviting': 6,
      'travel': 7,
      'child': 8
    };
    if (sectionParam && sectionMap.hasOwnProperty(sectionParam)) {
      navigateSection(sectionMap[sectionParam]);
      // Clear the query parameter so it doesn't trigger on reload.
      history.replaceState(null, '', window.location.pathname);
    }
  });
</script>

{% endblock %}
